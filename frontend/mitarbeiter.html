<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Mitarbeiter</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">



<style>
body {
    background:#f4f6f9;
    height:100%;
}

.sidebar {
    width:17.5%;            /* 30% kleiner als 25% */
    background:white;
    border-right:1px solid #e0e0e0;
}

.main-content {
    width:82.5%;
}

.status-led {
    font-size:28px;
    font-weight:bold;
}

.table thead {
    background:#1f2937;
    color:white;
}

.table td {
    vertical-align:middle;
    font-size:14px;
}

.btn-sidebar {
    text-align:left;
}

.modal-body label {
    font-weight:500;
    margin-top:8px;
}
</style>

</head>
<body>

<div class="container-fluid h-100">
<div class="d-flex h-100">


<!-- SIDEBAR -->
<div class="col-3 sidebar p-4 d-flex flex-column">

<h5 class="fw-bold mb-4">Mitarbeiter</h5>

<button class="btn btn-success btn-sidebar mb-2" onclick="openModal()">â• Neuer Mitarbeiter</button>
<button class="btn btn-primary btn-sidebar mb-2" onclick="editSelected()">âœï¸ Bearbeiten</button>
<input type="file" id="csvFile" accept=".csv" style="display:none" onchange="importCSV(event)">
<button class="btn btn-secondary btn-sidebar mb-2" onclick="document.getElementById('csvFile').click()">
ğŸ“¥ CSV importieren
</button>
<button class="btn btn-warning btn-sidebar mb-2" onclick="toggleAll()">â˜‘ Alle auswÃ¤hlen</button>
<button class="btn btn-danger btn-sidebar mb-4" onclick="deleteSelected()">ğŸ—‘ï¸ LÃ¶schen</button>

<div class="mt-auto">
<div id="statusLed" class="status-led text-success">â—</div>
<div id="statusText" class="fw-bold">Alle Mitarbeiter eingeteilt</div>
<div id="statusList" class="small text-danger"></div>
</div>

</div>

<!-- MAIN -->
<div class="main-content p-4">

<div class="mb-3">
<input type="text" id="filter" class="form-control" placeholder="ğŸ” Filtern..." onkeyup="loadData()">
</div>

<div class="table-responsive" style="max-height: calc(100vh - 160px); overflow-y: auto;">
<table class="table table-bordered table-hover">
<thead class="table-dark">
<tr id="headerRow"></tr>
<th style="width:50px">âœ“</th>
<th>Vorname</th>
<th>Nachname</th>
<th>Geburtstag</th>
<th>Anschrift</th>
<th>AnstellungsverhÃ¤ltnis</th>
<th>Vertrag an</th>
<th>Vertrag unterzeichnet</th>
<th>Woche (h)</th>
<th>Monat (h)</th>
<th>Sub-Unternehmen</th>
<th>Schichten</th>
<th>Stundensatz</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

</div>
</div>
</div>

<!-- MODAL -->
<div class="modal fade" id="editorModal">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Mitarbeiter</h5>
<button class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body" id="modalFields"></div>
<div class="modal-footer">
<button class="btn btn-success" onclick="saveEntry()">Speichern</button>
</div>
</div>
</div>
</div>

<script>
const felder = [
"Vorname","Nachname","Geburtstag","Anschrift",
"AnstellungsverhÃ¤ltnis","Arbeitsvertrag an",
"Arbeitsvertrag unterzeichnet",
"Arbeitsmodell (h) pro Woche",
"Arbeitsmodell (h) pro Monat",
"Sub-Unternehmen","Schichten","Stundensatz (â‚¬)"
];

let editIndex = null;

async function loadData(){
const res = await fetch("https://gmatrix-backend.onrender.com/mitarbeiter");
const data = await res.json();
const filter = document.getElementById("filter").value.toLowerCase();
const tbody = document.getElementById("tableBody");
tbody.innerHTML="";

data.forEach((row,index)=>{
while(row.length < felder.length) row.push("");

if(filter && !row.join(" ").toLowerCase().includes(filter)) return;

tbody.innerHTML += `
<tr>
<td onclick="toggleCheck(this)">â˜</td>
${row.map(v=>`<td>${v}</td>`).join("")}
</tr>`;
});

updateStatus(data);
}

function toggleCheck(cell){
cell.innerText = cell.innerText==="â˜" ? "âœ“" : "â˜";
}

function toggleAll(){
document.querySelectorAll("#tableBody tr td:first-child")
.forEach(td=> td.innerText="âœ“");
}

async function deleteSelected(){
let rows = document.querySelectorAll("#tableBody tr");
let indices=[];
rows.forEach((row,i)=>{
if(row.children[0].innerText==="âœ“") indices.push(i);
});
for(let i=indices.length-1;i>=0;i--){
await fetch(`https://gmatrix-backend.onrender.com/mitarbeiter/${indices[i]}`,{method:"DELETE"});
}
loadData();
}

function openModal(){
editIndex=null;
generateModalFields();
new bootstrap.Modal(document.getElementById("editorModal")).show();
}

function editSelected(){
let rows=document.querySelectorAll("#tableBody tr");
let selected=[];
rows.forEach((row,i)=>{
if(row.children[0].innerText==="âœ“") selected.push(i);
});
if(selected.length!==1){ alert("Bitte genau einen auswÃ¤hlen"); return; }
editIndex=selected[0];
generateModalFields(rows[editIndex]);
new bootstrap.Modal(document.getElementById("editorModal")).show();
}

function generateModalFields(row=null){
let container=document.getElementById("modalFields");
container.innerHTML="";
felder.forEach((feld,i)=>{
let value=row ? row.children[i+1].innerText : "";
container.innerHTML += `
<label>${feld}</label>
<input id="f${i}" class="form-control" value="${value}">
`;
});
}

async function saveEntry(){
let values=[];
for(let i=0;i<felder.length;i++){
values.push(document.getElementById(`f${i}`).value);
}
if(editIndex!==null){
await fetch("https://gmatrix-backend.onrender.com/mitarbeiter",{
method:"DELETE"});
}
const response = await fetch("https://gmatrix-backend.onrender.com/mitarbeiter", {
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify(values)
});
loadData();
bootstrap.Modal.getInstance(document.getElementById("editorModal")).hide();
}

function updateStatus(data){
let fehlend=[];
data.forEach(row=>{
if(!row[10] || row[10].length===0){
fehlend.push(row[1]+" "+row[0]);
}
});
if(fehlend.length){
document.getElementById("statusLed").className="status-led text-danger";
document.getElementById("statusText").innerText="Nicht alle Mitarbeiter eingeteilt";
document.getElementById("statusList").innerText=fehlend.join("\n");
}else{
document.getElementById("statusLed").className="status-led text-success";
document.getElementById("statusText").innerText="Alle Mitarbeiter eingeteilt";
document.getElementById("statusList").innerText="";
}
}

loadData();

async function importCSV(event) {

    const file = event.target.files[0];
    if (!file) return;

    const text = await file.text();
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");

    if (lines.length < 2) {
        alert("CSV enthÃ¤lt keine Daten.");
        return;
    }

    const dataRows = lines.slice(1);

    let neueEintraege = [];

    dataRows.forEach(line => {

        const values = line.split(";").map(v => v.trim());

        if (values.length < 11) return;

        let row = [
            values[0] || "",
            values[1] || "",
            values[2] || "",
            values[3] || "",
            values[4] || "",
            values[5] || "",
            values[6] || "",
            values[7] || "",
            values[8] || "",
            values[9] || "",
            "",               // Schichten leer
            values[10] || ""
        ];

        neueEintraege.push(row);
    });

    for (let row of neueEintraege) {
        const response = await fetch("https://gmatrix-backend.onrender.com/mitarbeiter", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(row)
        });

        if (!response.ok) {
            console.error("Fehler:", await response.text());
        }
    }

    alert(`${neueEintraege.length} Mitarbeiter importiert.`);
    loadData();
}

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
