<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Filialen</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
    background:#f4f6f9;
    height:100%;
}

.sidebar {
    width:17.5%;            /* 30% kleiner als 25% */
    background:white;
    border-right:1px solid #e0e0e0;
}

.main-content {
    width:82.5%;
}

.status-led {
    font-size:28px;
    font-weight:bold;
}

.table thead {
    background:#1f2937;
    color:white;
}

.table td {
    vertical-align:middle;
    font-size:14px;
}

.btn-sidebar {
    text-align:left;
}

.modal-body label {
    font-weight:500;
    margin-top:8px;
}
</style>

</head>

<body>

<div class="container-fluid h-100">
<div class="d-flex h-100">


<!-- SIDEBAR -->
<div class="col-3 sidebar p-4 d-flex flex-column">

<h5 class="fw-bold mb-4">Filialen</h5>

<button class="btn btn-success btn-sidebar mb-2"  onclick="neueFiliale()">
‚ûï Neue Filiale
</button>

<button class="btn btn-primary btn-sidebar mb-2" onclick="bearbeiten()">
‚úèÔ∏è Bearbeiten
</button>

<button class="btn btn-secondary btn-sidebar mb-2"  onclick="importCSV()">
üì• CSV importieren
</button>

<button class="btn btn-warning btn-sidebar mb-2"  onclick="toggleAlle()">
‚òë Alle ausw√§hlen
</button>

<button class="btn btn-danger btn-sidebar mb-2"  onclick="loeschen()">
üóëÔ∏è L√∂schen
</button>

</div>

<!-- MAIN -->
<div class="main-content p-4">

<input class="form-control mb-3" placeholder="üîç Filtern..." onkeyup="filterTable(this.value)">



<div class="table-responsive"style="max-height: calc(100vh - 160px); overflow-y: auto;">
<table class="table table-bordered table-striped" id="filialenTable">
<thead class="table-dark">
<tr>
<th>‚úì</th>
<th>Nr</th>
<th>Bezeichnung</th>
<th>PLZ</th>
<th>Ort</th>
<th>Stra√üe</th>
<th>Kontakt</th>
<th>Wochentage</th>
<th>Firmenzeiten</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

</div>
</div>
</div>

<script>

const API = "https://gmatrix-backend.onrender.com";

/* =========================================
   DATEN LADEN
========================================= */
async function loadData() {
    try {
        const res = await fetch(API + "/filialen");
        const data = await res.json();

        const tbody = document.querySelector("#filialenTable tbody");
        tbody.innerHTML = "";

        data.forEach((row, index) => {

            const tr = document.createElement("tr");

            tr.innerHTML = `
                <td><input type="checkbox" data-index="${index}"></td>
                <td>${row[0] || ""}</td>
                <td>${row[1] || ""}</td>
                <td>${row[2] || ""}</td>
                <td>${row[3] || ""}</td>
                <td>${row[4] || ""}</td>
                <td>${row[5] || ""}</td>
                <td>${row[6] || ""}</td>
                <td>${row[7] || ""}</td>
            `;

            tbody.appendChild(tr);
        });

        // Statusanzeige
        const status = document.getElementById("statusFilialen");
        if (status) {
            status.innerText = data.length + " Filialen geladen";
        }

    } catch (error) {
        console.error("Fehler beim Laden:", error);
        alert("Backend nicht erreichbar.");
    }
}


/* =========================================
   NEUE FILIALE
========================================= */
async function neueFiliale() {

    const nr = prompt("Filial-Nr:");
    const bez = prompt("Bezeichnung:");

    if (!nr || !bez) return;

    const neue = [nr, bez, "", "", "", "", "", ""];

    await fetch(API + "/filialen", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(neue)
    });

    loadData();
}


/* =========================================
   BEARBEITEN
========================================= */
async function bearbeiten() {

    const checked = document.querySelectorAll("#filialenTable input[type=checkbox]:checked");

    if (checked.length !== 1) {
        alert("Bitte genau eine Filiale ausw√§hlen.");
        return;
    }

    const index = checked[0].dataset.index;

    const nr = prompt("Neue Filial-Nr:");
    const bez = prompt("Neue Bezeichnung:");

    if (!nr || !bez) return;

    // Alte l√∂schen
    await fetch(API + "/filialen/" + index, {
        method: "DELETE"
    });

    // Neue speichern
    await fetch(API + "/filialen", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify([nr, bez, "", "", "", "", "", ""])
    });

    loadData();
}


/* =========================================
   L√ñSCHEN
========================================= */
async function loeschen() {

    const checks = document.querySelectorAll("#filialenTable input[type=checkbox]:checked");

    if (checks.length === 0) return;

    if (!confirm("Ausgew√§hlte Filialen wirklich l√∂schen?")) return;

    for (let c of checks) {
        await fetch(API + "/filialen/" + c.dataset.index, {
            method: "DELETE"
        });
    }

    loadData();
}


/* =========================================
   FILTER
========================================= */
function filterTable(text) {

    text = text.toLowerCase();

    document.querySelectorAll("#filialenTable tbody tr").forEach(row => {

        row.style.display =
            row.innerText.toLowerCase().includes(text)
            ? ""
            : "none";
    });
}


/* =========================================
   ALLE AUSW√ÑHLEN
========================================= */
function toggleAlle() {

    const checkboxes = document.querySelectorAll("#filialenTable input[type=checkbox]");
    const alleChecked = [...checkboxes].every(cb => cb.checked);

    checkboxes.forEach(cb => cb.checked = !alleChecked);
}


/* =========================================
   CSV IMPORT
========================================= */
function importCSV() {

    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".csv";

    input.onchange = async function(event) {

        const file = event.target.files[0];
        if (!file) return;

        const text = await file.text();
        const lines = text.split("\n").slice(1);

        for (let line of lines) {

            if (!line.trim()) continue;

            const values = line.split(";").map(v => v.trim());

            await fetch(API + "/filialen", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(values)
            });
        }

        alert("CSV importiert");
        loadData();
    };

    input.click();
}


/* =========================================
   INIT
========================================= */
loadData();

</script>


</body>
</html>
